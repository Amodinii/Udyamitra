name: Build, Push Docker Images & Deploy to Render

on:
  push:
    branches:
      - prod  # trigger on push to prod

env:
  GHCR_REPO: data-g-i-v-e/udyamitra  # lowercase GHCR repo name
  RENDER_SERVICE_ID: srv-d451j2e3jp1c73ehmp5g
  RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }} 

jobs:
  build-push-deploy:
    runs-on: ubuntu-latest

    steps:
      #  Checkout repo
      - name: Checkout repository
        uses: actions/checkout@v4

      # Set up Docker Buildx
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # Log in to GHCR using PAT
      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: nottpande       # account that owns the PAT
          password: ${{ secrets.GHCR_PAT }}

      # Build & Push Backend image
      - name: Build & Push Backend
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./DockerFile
          push: true
          tags: |
            ghcr.io/${{ env.GHCR_REPO }}/backend:latest
            ghcr.io/${{ env.GHCR_REPO }}/backend:${{ github.run_number }}

      # Build & Push MCP image
      - name: Build & Push MCP
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./DockerFile
          push: true
          build-args: |
            SERVICE=mcp
          tags: |
            ghcr.io/${{ env.GHCR_REPO }}/mcp:latest
            ghcr.io/${{ env.GHCR_REPO }}/mcp:${{ github.run_number }}

      # Trigger Render deploy
      - name: Trigger Render Deployment
        run: |
          curl -X POST "https://api.render.com/deploy/${{ env.RENDER_SERVICE_ID }}" \
          -H "Accept: application/json" \
          -H "Authorization: Bearer ${{ env.RENDER_API_KEY }}"
